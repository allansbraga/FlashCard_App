{% extends 'base.html' %}

{% block title %}Review Flashcards - FlashCard App{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h2 class="h4 mb-0">Flashcard Review</h2>
    </div>
    <div class="card-body">
        <p>Review your flashcards and rate how well you remembered each one. This helps the system optimize your learning experience.</p>
    </div>
</div>

{% if cards %}
<div id="reviewContainer">
    <div class="progress mb-4">
        <div id="reviewProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    
    <div id="cardContainer" class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span id="currentCardNumber">Card 1 of {{ cards|length }}</span>
            <span id="currentCategory" class="badge bg-info"></span>
        </div>
        <div class="card-body">
            <div id="cardFront" class="review-card-content">
                <h3 class="card-title text-center mb-4">Question</h3>
                <p id="frontContent" class="lead text-center"></p>
            </div>
            <div id="cardBack" class="review-card-content d-none">
                <h3 class="card-title text-center mb-4">Answer</h3>
                <p id="backContent" class="lead text-center"></p>
            </div>
        </div>
        <div class="card-footer text-center">
            <button id="flipButton" class="btn btn-primary mb-3">Show Answer</button>
            
            <div id="ratingContainer" class="d-none">
                <p class="mb-2">How well did you know this?</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-danger rating-btn" data-rating="1">1 - Not at all</button>
                    <button type="button" class="btn btn-outline-warning rating-btn" data-rating="2">2 - Barely</button>
                    <button type="button" class="btn btn-outline-secondary rating-btn" data-rating="3">3 - Somewhat</button>
                    <button type="button" class="btn btn-outline-info rating-btn" data-rating="4">4 - Well</button>
                    <button type="button" class="btn btn-outline-success rating-btn" data-rating="5">5 - Perfectly</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="reviewComplete" class="d-none">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h2 class="h4 mb-0">Review Complete!</h2>
        </div>
        <div class="card-body text-center">
            <p class="lead">Great job! You've completed your review session.</p>
            <p>Continue reviewing regularly to improve your memory retention.</p>
            <div class="mt-4">
                <a href="{{ url_for('review') }}" class="btn btn-primary me-2">Review Again</a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Store the cards data from the server
    const cardsData = [
        {% for card in cards %}
        {
            "id": {{ card.id|tojson }},
            "front": {{ card.front_content|tojson }},
            "back": {{ card.back_content|tojson }},
            "category": {{ (card.category_name or 'Uncategorized')|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
{% else %}
<div class="alert alert-info">
    <p>No flashcards available for review at this time.</p>
    <p>This could be because:</p>
    <ul>
        <li>You haven't created any flashcards yet</li>
        <li>You've recently reviewed all your flashcards</li>
    </ul>
    <p>
        <a href="{{ url_for('add_flashcard') }}" class="alert-link">Create new flashcards</a> or 
        <a href="{{ url_for('index') }}" class="alert-link">return to the home page</a>.
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if cards %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentCardIndex = 0;
        const totalCards = cardsData.length;
        
        // DOM elements
        const reviewContainer = document.getElementById('reviewContainer');
        const reviewComplete = document.getElementById('reviewComplete');
        const progressBar = document.getElementById('reviewProgress');
        const currentCardNumber = document.getElementById('currentCardNumber');
        const currentCategory = document.getElementById('currentCategory');
        const frontContent = document.getElementById('frontContent');
        const backContent = document.getElementById('backContent');
        const cardFront = document.getElementById('cardFront');
        const cardBack = document.getElementById('cardBack');
        const flipButton = document.getElementById('flipButton');
        const ratingContainer = document.getElementById('ratingContainer');
        const ratingButtons = document.querySelectorAll('.rating-btn');
        
        // Initialize the first card
        loadCard(currentCardIndex);
        
        // Flip button event
        flipButton.addEventListener('click', function() {
            if (cardFront.classList.contains('d-none')) {
                // Show front
                cardFront.classList.remove('d-none');
                cardBack.classList.add('d-none');
                ratingContainer.classList.add('d-none');
                flipButton.textContent = 'Show Answer';
            } else {
                // Show back
                cardFront.classList.add('d-none');
                cardBack.classList.remove('d-none');
                ratingContainer.classList.remove('d-none');
                flipButton.textContent = 'Show Question';
            }
        });
        
        // Rating buttons event
        ratingButtons.forEach(button => {
            button.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                submitRating(cardsData[currentCardIndex].id, rating);
            });
        });
        
        // Load card data
        function loadCard(index) {
            const card = cardsData[index];
            frontContent.textContent = card.front;
            backContent.textContent = card.back;
            currentCardNumber.textContent = `Card ${index + 1} of ${totalCards}`;
            currentCategory.textContent = card.category;
            
            // Reset card state
            cardFront.classList.remove('d-none');
            cardBack.classList.add('d-none');
            ratingContainer.classList.add('d-none');
            flipButton.textContent = 'Show Answer';
            
            // Update progress
            const progress = (index / totalCards) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }
        
        // Submit rating and move to next card
        function submitRating(flashcardId, rating) {
            // Send rating to server
            fetch('{{ url_for("record_review") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `flashcard_id=${flashcardId}&rating=${rating}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Move to next card
                    currentCardIndex++;
                    
                    if (currentCardIndex < totalCards) {
                        loadCard(currentCardIndex);
                    } else {
                        // Review complete
                        reviewContainer.classList.add('d-none');
                        reviewComplete.classList.remove('d-none');
                    }
                } else {
                    alert('Error recording review: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error recording review. Please try again.');
            });
        }
    });
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .review-card-content {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    #cardContainer {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    #cardContainer:hover {
        transform: translateY(-5px);
    }
    
    .rating-btn {
        transition: all 0.2s ease;
    }
    
    .rating-btn:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}